<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Settings - Dan Brown Art Tracker</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-card: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #888;
            --accent: #c9a227;
            --accent-soft: #8b7355;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-btn {
            background: transparent;
            border: 1px solid var(--accent-soft);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.05);
        }

        header h1 {
            font-size: 1.25rem;
            font-weight: 400;
        }

        header h1 span {
            color: var(--accent);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        @media (max-width: 1000px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        /* Preview Frame */
        .preview-section {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        .preview-header {
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h2 {
            font-size: 1rem;
            font-weight: 500;
            color: var(--accent);
        }

        .preview-controls {
            display: flex;
            gap: 0.5rem;
        }

        .preview-controls button {
            background: transparent;
            border: 1px solid var(--accent-soft);
            color: var(--text-primary);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .preview-controls button:hover {
            background: rgba(255,255,255,0.05);
        }

        .preview-controls button.active {
            background: var(--accent);
            border-color: var(--accent);
            color: black;
        }

        .frame-container {
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 500px;
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
        }

        .frame {
            position: relative;
            background: #2a2520;
            padding: 20px;
            box-shadow:
                inset 0 2px 4px rgba(0,0,0,0.5),
                0 10px 40px rgba(0,0,0,0.5),
                0 0 0 3px #3a3530,
                0 0 0 6px #2a2520;
            border-radius: 2px;
        }

        .frame.ornate {
            padding: 30px;
            background: linear-gradient(135deg, #8b6914 0%, #5c4a0f 50%, #8b6914 100%);
            box-shadow:
                inset 0 2px 4px rgba(0,0,0,0.5),
                inset 0 -2px 4px rgba(255,255,255,0.1),
                0 10px 40px rgba(0,0,0,0.5),
                0 0 0 4px #6b5314,
                0 0 0 8px #4a390f;
        }

        .frame.minimal {
            padding: 8px;
            background: #222;
            box-shadow:
                0 5px 20px rgba(0,0,0,0.3);
        }

        .frame.none {
            padding: 0;
            background: transparent;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .frame-inner {
            position: relative;
            overflow: hidden;
            background: #111;
        }

        .frame-image {
            display: block;
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
        }

        .frame-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            padding: 2rem 1rem 1rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .frame:hover .frame-info,
        .frame-info.visible {
            opacity: 1;
        }

        .frame-title {
            font-size: 1rem;
            font-weight: 300;
            color: white;
        }

        .frame-artist {
            font-size: 0.8rem;
            color: var(--accent);
            margin-top: 0.25rem;
        }

        .no-preview {
            color: var(--text-secondary);
            text-align: center;
            padding: 4rem 2rem;
        }

        .no-preview-icon {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        /* Settings Panel */
        .settings-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .settings-card {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        .settings-card h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent);
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .settings-content {
            padding: 1.5rem;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .setting-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        select, input[type="number"] {
            background: var(--bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
        }

        input[type="range"] {
            width: 120px;
            accent-color: var(--accent);
        }

        .toggle {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle.active {
            background: var(--accent);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle.active::after {
            transform: translateX(24px);
        }

        /* Artwork Selection */
        .artwork-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .artwork-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .artwork-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .artwork-item.selected {
            background: rgba(201, 162, 39, 0.15);
        }

        .artwork-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            background: var(--bg-secondary);
        }

        .artwork-name {
            flex: 1;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .artwork-check {
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-soft);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
        }

        .artwork-item.selected .artwork-check {
            background: var(--accent);
            border-color: var(--accent);
            color: black;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-box {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 300;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: black;
            width: 100%;
            justify-content: center;
        }

        .btn-primary:hover {
            background: #d4ad30;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--accent-soft);
        }

        /* Fullscreen Preview */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-image {
            max-width: 95vw;
            max-height: 95vh;
            object-fit: contain;
        }

        .fullscreen-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .fullscreen-info {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: white;
        }

        .fullscreen-title {
            font-size: 1.5rem;
            font-weight: 300;
        }

        .fullscreen-artist {
            color: var(--accent);
            margin-top: 0.5rem;
        }

        .fullscreen-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .fullscreen-nav:hover {
            background: rgba(255,255,255,0.2);
        }

        .fullscreen-nav.prev {
            left: 2rem;
        }

        .fullscreen-nav.next {
            right: 2rem;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 2px solid var(--bg-card);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <a href="/" class="back-btn">&larr; Back to Dashboard</a>
        <h1><span>Display Frame</span> Settings</h1>
    </header>

    <div class="container">
        <!-- Preview Section -->
        <div class="preview-section">
            <div class="preview-header">
                <h2>Preview</h2>
                <div class="preview-controls">
                    <button onclick="prevArtwork()">&larr;</button>
                    <button onclick="togglePlay()" id="play-btn">Pause</button>
                    <button onclick="nextArtwork()">&rarr;</button>
                    <button onclick="enterFullscreen()">Fullscreen</button>
                </div>
            </div>
            <div class="frame-container">
                <div class="frame" id="frame">
                    <div class="frame-inner">
                        <img id="preview-image" class="frame-image" src="" alt="">
                        <div class="frame-info" id="frame-info">
                            <div class="frame-title" id="frame-title">-</div>
                            <div class="frame-artist">Dan Brown (1949-2022)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="settings-section">
            <!-- Display Stats -->
            <div class="settings-card">
                <h3>Display Status</h3>
                <div class="settings-content">
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="stat-total">-</div>
                            <div class="stat-label">Total Artworks</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-selected">-</div>
                            <div class="stat-label">In Rotation</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-current">-</div>
                            <div class="stat-label">Current</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="stat-interval">-</div>
                            <div class="stat-label">Interval</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Display Settings -->
            <div class="settings-card">
                <h3>Settings</h3>
                <div class="settings-content">
                    <div class="setting-row">
                        <span class="setting-label">Frame Style</span>
                        <div class="setting-value">
                            <select id="frame-style" onchange="updateFrameStyle()">
                                <option value="classic">Classic Wood</option>
                                <option value="ornate">Ornate Gold</option>
                                <option value="minimal">Minimal</option>
                                <option value="none">No Frame</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Rotation Interval</span>
                        <div class="setting-value">
                            <select id="rotation-interval" onchange="updateInterval()">
                                <option value="30">30 seconds</option>
                                <option value="60">1 minute</option>
                                <option value="300">5 minutes</option>
                                <option value="600">10 minutes</option>
                                <option value="1800">30 minutes</option>
                                <option value="3600" selected>1 hour</option>
                                <option value="7200">2 hours</option>
                                <option value="14400">4 hours</option>
                                <option value="21600">6 hours</option>
                                <option value="43200">12 hours</option>
                                <option value="86400">1 day</option>
                                <option value="172800">2 days</option>
                                <option value="259200">3 days</option>
                                <option value="604800">1 week</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Show Title Overlay</span>
                        <div class="setting-value">
                            <div class="toggle active" id="toggle-title" onclick="toggleSetting('title')"></div>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Verified Only</span>
                        <div class="setting-value">
                            <div class="toggle active" id="toggle-verified" onclick="toggleSetting('verified')"></div>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Shuffle Order</span>
                        <div class="setting-value">
                            <div class="toggle active" id="toggle-shuffle" onclick="toggleSetting('shuffle')"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Artwork Selection -->
            <div class="settings-card">
                <h3>Artwork Selection</h3>
                <div class="settings-content">
                    <div id="artwork-loading" class="loading">
                        <div class="spinner"></div>
                    </div>
                    <div id="artwork-list" class="artwork-list" style="display: none;"></div>
                </div>
            </div>

            <!-- Save Button -->
            <button class="btn btn-primary" onclick="saveSettings()">
                Save Settings
            </button>

            <!-- Launch Frame Mode -->
            <a href="/frame" class="btn btn-primary" style="margin-top: 1rem; background: #27ae60; text-decoration: none; text-align: center;">
                Launch Frame Mode
            </a>
        </div>
    </div>

    <!-- Fullscreen Overlay -->
    <div class="fullscreen-overlay" id="fullscreen">
        <button class="fullscreen-close" onclick="exitFullscreen()">&times;</button>
        <button class="fullscreen-nav prev" onclick="prevArtwork()">&larr;</button>
        <img class="fullscreen-image" id="fullscreen-image" src="" alt="">
        <button class="fullscreen-nav next" onclick="nextArtwork()">&rarr;</button>
        <div class="fullscreen-info">
            <div class="fullscreen-title" id="fullscreen-title">-</div>
            <div class="fullscreen-artist">Dan Brown (1949-2022)</div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let artworks = [];
        let currentIndex = 0;
        let rotationTimer = null;
        let isPlaying = true;
        let settings = {
            frameStyle: 'classic',
            interval: 3600,  // Default: 1 hour
            showTitle: true,
            verifiedOnly: true,
            shuffle: true,
            selectedIds: []
        };

        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('displaySettings');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
            }
            applySettings();
        }

        function applySettings() {
            document.getElementById('frame-style').value = settings.frameStyle;
            document.getElementById('rotation-interval').value = settings.interval;
            document.getElementById('toggle-title').classList.toggle('active', settings.showTitle);
            document.getElementById('toggle-verified').classList.toggle('active', settings.verifiedOnly);
            document.getElementById('toggle-shuffle').classList.toggle('active', settings.shuffle);
            updateFrameStyle();
            updateInterval();
            updateTitleVisibility();
        }

        function saveSettings() {
            settings.frameStyle = document.getElementById('frame-style').value;
            settings.interval = parseInt(document.getElementById('rotation-interval').value);
            settings.showTitle = document.getElementById('toggle-title').classList.contains('active');
            settings.verifiedOnly = document.getElementById('toggle-verified').classList.contains('active');
            settings.shuffle = document.getElementById('toggle-shuffle').classList.contains('active');

            // Get selected artwork IDs
            const selected = document.querySelectorAll('.artwork-item.selected');
            settings.selectedIds = Array.from(selected).map(el => parseInt(el.dataset.id));

            localStorage.setItem('displaySettings', JSON.stringify(settings));
            alert('Settings saved!');

            // Reload artworks with new settings
            loadArtworks();
        }

        async function loadArtworks() {
            const loading = document.getElementById('artwork-loading');
            const list = document.getElementById('artwork-list');

            try {
                const verifiedParam = settings.verifiedOnly ? '&verified_only=true' : '';
                const response = await fetch(`${API_BASE}/artworks/?limit=100${verifiedParam}`);
                const data = await response.json();

                artworks = data.filter(a => a.primary_image_url);

                if (settings.shuffle) {
                    shuffleArray(artworks);
                }

                // Render artwork list
                list.innerHTML = artworks.map(artwork => `
                    <div class="artwork-item ${settings.selectedIds.length === 0 || settings.selectedIds.includes(artwork.id) ? 'selected' : ''}"
                         data-id="${artwork.id}"
                         onclick="toggleArtworkSelection(this, ${artwork.id})">
                        <img class="artwork-thumb" src="${artwork.primary_image_url}" alt="">
                        <span class="artwork-name">${escapeHtml(artwork.title)}</span>
                        <span class="artwork-check">&#10003;</span>
                    </div>
                `).join('');

                loading.style.display = 'none';
                list.style.display = 'block';

                // Filter to selected artworks for display
                if (settings.selectedIds.length > 0) {
                    artworks = artworks.filter(a => settings.selectedIds.includes(a.id));
                }

                updateStats();
                if (artworks.length > 0) {
                    showArtwork(0);
                    startRotation();
                }
            } catch (e) {
                console.error(e);
                loading.innerHTML = '<p>Failed to load artworks</p>';
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function toggleArtworkSelection(el, id) {
            el.classList.toggle('selected');
        }

        function showArtwork(index) {
            if (artworks.length === 0) return;

            currentIndex = index;
            const artwork = artworks[index];

            const imageUrl = artwork.primary_image_url
                .replace('w_320,h_320', 'w_800,h_800')
                .replace('w_800,h_800', 'w_1200,h_1200');

            document.getElementById('preview-image').src = imageUrl;
            document.getElementById('frame-title').textContent = artwork.title;
            document.getElementById('fullscreen-image').src = imageUrl;
            document.getElementById('fullscreen-title').textContent = artwork.title;

            document.getElementById('stat-current').textContent = `${index + 1}/${artworks.length}`;
        }

        function nextArtwork() {
            const next = (currentIndex + 1) % artworks.length;
            showArtwork(next);
            resetRotation();
        }

        function prevArtwork() {
            const prev = (currentIndex - 1 + artworks.length) % artworks.length;
            showArtwork(prev);
            resetRotation();
        }

        function startRotation() {
            if (rotationTimer) clearInterval(rotationTimer);
            rotationTimer = setInterval(() => {
                if (isPlaying) nextArtwork();
            }, settings.interval * 1000);
        }

        function resetRotation() {
            if (isPlaying) {
                startRotation();
            }
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            document.getElementById('play-btn').textContent = isPlaying ? 'Pause' : 'Play';
        }

        function updateFrameStyle() {
            const frame = document.getElementById('frame');
            const style = document.getElementById('frame-style').value;
            frame.className = 'frame';
            if (style !== 'classic') {
                frame.classList.add(style);
            }
            settings.frameStyle = style;
        }

        function updateInterval() {
            settings.interval = parseInt(document.getElementById('rotation-interval').value);
            document.getElementById('stat-interval').textContent = formatInterval(settings.interval);
            if (isPlaying) startRotation();
        }

        function formatInterval(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d`;
            return `${Math.floor(seconds / 604800)}w`;
        }

        function toggleSetting(name) {
            const toggle = document.getElementById(`toggle-${name}`);
            toggle.classList.toggle('active');

            if (name === 'title') {
                updateTitleVisibility();
            } else if (name === 'verified') {
                settings.verifiedOnly = toggle.classList.contains('active');
                loadArtworks();
            } else if (name === 'shuffle') {
                settings.shuffle = toggle.classList.contains('active');
                if (settings.shuffle) shuffleArray(artworks);
                showArtwork(0);
            }
        }

        function updateTitleVisibility() {
            const visible = document.getElementById('toggle-title').classList.contains('active');
            document.getElementById('frame-info').classList.toggle('visible', visible);
            settings.showTitle = visible;
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = artworks.length;
            document.getElementById('stat-selected').textContent = artworks.length;
            document.getElementById('stat-interval').textContent = formatInterval(settings.interval);
        }

        function enterFullscreen() {
            document.getElementById('fullscreen').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function exitFullscreen() {
            document.getElementById('fullscreen').classList.remove('active');
            document.body.style.overflow = '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') exitFullscreen();
            if (e.key === 'ArrowLeft') prevArtwork();
            if (e.key === 'ArrowRight') nextArtwork();
            if (e.key === ' ') { e.preventDefault(); togglePlay(); }
            if (e.key === 'f') enterFullscreen();
        });

        // Initialize
        loadSettings();
        loadArtworks();
    </script>
</body>
</html>
